const Utils = require('../../utils/index');
const describe = require('mocha').describe;
const it = require('mocha').it;

let sut;
let fake_profile = Utils.closure();

describe('auth', () => {
    before(() => {
        sut = require('../../index');
        return createProfile()
            .then(createUser)
            .catch(reason => console.error('all the reason', reason));
    });

    describe('.login', () => {
        it('should succeed when all information are correct', (done) => {
            sut.actions.auth
                .login({
                    data: {
                        email: 'user@digipolitan.com',
                        password: 'password'
                    }
                })
                .should.be.fulfilled
                .and.notify(done)
        });

        it('should fail email is unknown', (done) => {
            sut.actions.auth
                .login({
                    data: {
                        email: 'wrong@digipolitan.com',
                        password: 'password'
                    }
                })
                .should.be.rejectedWith(Error)
                .and.notify(done)
        });

        it('should fail password is incorrect', (done) => {
            sut.actions.auth
                .login({
                    data: {
                        email: 'user@digipolitan.com',
                        password: 'pazzword'
                    }
                })
                .should.be.rejectedWith(Error)
                .and.notify(done)
        });
    });

    after(() => {
        return clearUser()
            .then(clearProfile);
    })
});


function createUser() {
    return sut.actions.users
        .create({
            data: {
                email: 'user@digipolitan.com',
                password: 'password',
                profile: fake_profile.value(),
                company: 'Digipolitan'
            }
        })
}

function createProfile() {
    return sut.models.Profile.create({
        title: 'fake'
    })
        .then(fake_profile.assign)
}

function clearUser() {
    return sut.models.User.remove();
}

function clearProfile() {
    return sut.models.Profile.remove();
}