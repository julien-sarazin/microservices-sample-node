module.exports = app => {
    const User = app.models.User;

    return Action({
        execute: context => {
            const searches = context.request.query.search.split(' ').filter(s => s.length >= 2);
            const regexps = searches.map(search => new RegExp(`${search}`, 'i'));

            return User.find()
                .where({
                    $or: [
                        {first_name: {$in: regexps}},
                        {last_name: {$in: regexps}},
                        {email: {$in: regexps}},
                        {company: {$in: regexps}}
                    ]
                })
                .select(context.criteria.fields)
                .where(context.criteria.where)
                .skip(context.criteria.skip)
                .limit(context.criteria.limit)
                .sort(context.criteria.sort)
                .populate(context.criteria.includes);
        }
    });
};